= OntoRelQuery Tutorial
:doctype: book
:icons: font
:source-highlighter: highlightjs
:toc: left
:toclevels: 2
:sectnums:
:sectlinks:

== Introduction

OntoRelQuery is a tool for generating and executing queries using an ontology. This tool provides a command-line interface for querying relational data using ontology-based models.

The primary purpose of OntoRelQuery is to bridge the gap between ontological models and relational databases. By leveraging ontological relationships defined in graph structures, the tool allows users to create complex queries without having to understand the underlying database schema in detail. This approach provides a higher level of abstraction and better alignment with domain models.

This guide will walk you through the complete setup process, including:

* Setting up a source database
* Configuring OntoRel and OntoRelCat
* Configuring OntoRelQuery
* Running and using the tool

== Environment setup

This section will guide you through setting up the environment for the demonstraction.

=== Pre-requisites

Before you begin, ensure you have the following prerequisites installed:

* *Java 11 or higher* - Required to run the OntoRelQuery application
* *PostgreSQL 12 or higher* - Required for the database backend
* *Git* (optional) - For cloning the repository if building from source

Note. For now only PostgreSQL dabase is supported.

=== Creating the database

First, you need to create a new database.
We use the MIMIC-IV a medical open source database.

Follow the instructions at :
https://github.com/MIT-LCP/mimic-code/tree/main/mimic-iv/buildmimic/postgres
and
https://github.com/MIT-LCP/mimic-code/tree/main/mimic-iv-ed/buildmimic/postgres

=== Setting up OntoRel

OntoRel is generated by OntoRelA[https://github.com/OpenLHS/ontorela-application].
You need to execute the following SQL scripts in the specified order to set up the OntoRel structure and data.

. Navigate to the directory containing the SQL scripts for the structure:
+
[source,bash]
----
cd src/OntoRel/database
----
. Execute the following scripts in order:
+
[source,bash]
----
psql -U postgres -d mimiciv -f 100-MPHPO_cre-table_v0_20240820-1631.sql
psql -U postgres -d mimiciv -f 110-MPHPO_cre-participationCheck-fct_v0_20240820-1631.sql
psql -U postgres -d mimiciv -f 200-MPHPO_cre-view-iri_v0_20240820-1631.sql
psql -U postgres -d mimiciv -f 210-MPHPO_cre-view-en_v0_20240820-1631.sql
----
. Navigate to the directory containing the SQL scripts for the data:
+
[source,bash]
----
cd src/OntoRelMap
----
. Execute the following scripts in order:
+
----
psql -U postgres -d mimiciv -f 100-mapping-init.sql
psql -U postgres -d mimiciv -f 120-mphpo-ins.sql
----

=== Setting up OntoRelCat

OntoRelCat is the catalogue that contains information about the ontology and the derived relational model with specific store procedures to interact with OntoRelQuery.

. Navigate to the directory containing the SQL scripts for the structure:
+
[source,bash]
----
cd src/OntoRelCat
----
. Execute the following scripts:
+
[source,bash]
----
psql -U postgres -d mimiciv -f 1000_ontorelcat_pub.sql
psql -U postgres -d mimiciv -f 1010_ontorelcat_pri.sql
-- store procedures for the ontorelquery app
psql -U postgres -d mimiciv -f 3000_ontorelcat_api_ontorelquery_pub.sql
psql -U postgres -d mimiciv -f 3010_ontorelcat_api_ontorelquery_pri.sql
----

. Insert the data into the OntoRelCat:
+
[source,bash]
----
psql -U postgres -d mimiciv -f OntoRel/database/1003-MPHPO_OntoRelCat_ins_v0_20240820-1631.sql
----

== Setting up OntoRelQuery

This section will guide you through setting up the OntoRelQuery tool.
The configuration file `OntoRelQuery_config.yml` in the OntoRelQuery directory specifies parameters.

=== Configuration

.Database configuration
[cols="1,3"]
|===
|Parameter |Description

|`rdbms`
|The relational database management system to use. Currently, only PostgreSQL is fully supported.

|`host`
|The hostname or IP address of the database server. Use `localhost` if the database is on the same machine.

|`port`
|The port number on which the database server is listening. The default for PostgreSQL is `5432`.

|`databaseId`
|The name of the database to connect to. In our case, it's `mimic_iv`.

|`ontorelcatSchemaId`
|The schema name for OntoRelCat. In our case, it's `ontorelcat_pri`.

|`ontorelSchemaId`
|The schema name for OntoRel. In our case, it's `MPHPO`.

|`ontorelcatApi`
|The schema name for the OntoRelCat API. In our case, it's `ontorelquery_api`.

|`username`
|The username to use when connecting to the database. You can use environment variables with the syntax `${DB_USER:default_value}`.

|`password`
|The password to use when connecting to the database. You can use environment variables with the syntax `${DB_PASSWORD:default_value}`.
|===

[IMPORTANT]
====
Replace `your_password` with your actual PostgreSQL password.
====

Instead of hardcoding sensitive information like usernames and passwords in the configuration file, you can use environment variables:

Windows::
+
[source,batch]
----
set DB_USER=your_username
set DB_PASSWORD=your_password
----

macOS/Linux::
+
[source,bash]
----
export DB_USER=your_username
export DB_PASSWORD=your_password
----

.Graph files configuration
[cols="1,3"]
|===
|Parameter |Description

|`ontoGraphFile`
|The path to the ontological graph DOT file. You can use environment variables with the syntax `${ONTO_GRAPH_FILE:default_path}`.

|`ontoRelGraphFile`
|The path to the OntoRel graph DOT file. You can use environment variables with the syntax `${ONTOREL_GRAPH_FILE:default_path}`.
|===

.Query configuration
[cols="1,3"]
|===
|Parameter |Description

|`ontoreluuid`
|The UUID for OntoRel identification. You can use environment variables with the syntax `${ONTOREL_UUID:default_value}`.

|`queryLanguage`
|The query language setting. You can use environment variables with the syntax `${QUERY_LANGUAGE:default_value}`.

|`cacheSize`
|The maximum number of items to keep in the cache.

|`cacheExpirationMinutes`
|The number of minutes after which cache items expire.

|`maxQueryResults`
|The maximum number of results to return from a query.

|`defaultTimeout`
|The default timeout for queries in seconds.
|===

.SSH tunnel configuration
[cols="1,3"]
|===
|Parameter |Description

|`useSshTunnel`
|Whether to use an SSH tunnel to connect to the database. Set to `false` if the database is on the same machine or directly accessible.

|`sshHost`
|The hostname or IP address of the SSH server.

|`sshPort`
|The port number on which the SSH server is listening. The default is `22`.

|`sshUsername`
|The username to use when connecting to the SSH server. You can use environment variables with the syntax `${DB_USER:default_value}`.

|`sshPassword`
|The password to use when connecting to the SSH server. You can use environment variables with the syntax `${DB_PASSWORD:default_value}`.

|`sshKeyFile`
|The path to the SSH key file to use for authentication. Leave empty if using password authentication.
|===

=== Running OntoRelQuery
This section will guide you through running and using the OntoRelQuery tool.

. Download the JAR File
. Open a terminal or command prompt, navigate to the OntoRelQuery directory, and run:
+
[source,bash]
----
java -jar OntoRelQuery.jar --configuration OntoRelQuery_config.yml
----

If you're using environment variables for the database credentials, make sure they are set before running the command.

=== OntoRelQuery interface

Once launched, you will see the OntoRelQuery textuel interface with the following available commands:

[cols="1,3"]
|===
|Command |Description

|`mcr-list`
|List all available query models with descriptions and required options.

|`execute --type MODEL_NAME`
|Execute a specific query model. Replace `MODEL_NAME` with the name of the model you want to execute.

|`!MODEL_NAME`
|Shortcut to execute a model. For example, `!MS_SC` to execute the Simple Class Selection model.

|`clear`
|Clear the console.

|`help`
|Display help information.

|`exit`
|Exit the application.
|===

==== Query Models

OntoRelQuery supports several types of query models:

.Simple Models (MS_)
[cols="1,2,2"]
|===
|Model |Description |Required Options

|MS_SC
|Simple Class Selection
|class

|MS_SCPO
|Class Selection by Object Property
|class, objectProperty

|MS_SCPD
|Class Selection by Data Property
|class, dataProperty

|MS_SCH
|Class Selection by Hierarchy
|class, hierarchy

|MS_SCA
|Class Selection with Aggregation
|class

|MS_SCF
|Class Selection with Filter
|class

|MS_SCPOC
|Class Selection by Object Property Associated with Another Class
|domain, objectProperty, range
|===

.Iterative Models (MI_)
[cols="1,2,2"]
|===
|Model |Description |Required Options

|MI_AP
|All Possible Paths Between Two Classes
|from, to

|MI_SP
|Shortest Path Between Two Classes
|from, to

|MI_PPO
|Specific Object Property Path
|from, to, objectProperty
|===

.Combinatorial Model (MC_)
[cols="1,2,2"]
|===
|Model |Description |Required Options

|MC_COMBINATORIAL
|Combination of Multiple Models
|subModels
|===

=== Output artifacts

When you execute a request with OntoRelQuery, the tool generates several output artifacts that are stored in a timestamped folder in the specified output directory (if not specified  in the current directory).
These artifacts provide detailed information about the query execution process and results.

For each query execution, OntoRelQuery creates a timestamped folder with the following format:
`YYYY-MM-DD_HH-MM-SS` (e.g., `2025-05-23_13-18-05`).

Inside this folder, you'll find several files:

[cols="1,3"]
|===
|File |Description

|`<query_name>_parameters.txt`
|Contains the parameters used for the query, including the query model and any specific options provided.

|`<query_name>_catalog_result.txt`
|Contains the results of the catalog query, which is used to verify and retrieve table IDs from the OntoRelCat catalog.

|`<query_name>_query.sql`
|Contains the SQL query that was executed against the database.

|`<query_name>_result.csv`
|Contains the query results in CSV format, which can be imported into spreadsheet applications or other data analysis tools.

|`<query_name>_ontorel_subgraph.dot`
|Contains a DOT file representing the OntoRel subgraph used for the query. This file can be visualized using tools like Graphviz.

|`<query_name>_onto_subgraph.dot`
|Contains a DOT file representing the ontological subgraph used for the query. This file can be visualized using tools like Graphviz.

|`<query_name>_paths.txt`
|Contains information about the paths selected for the query, particularly useful for path-based queries (MI_).
|===

==== 5.6.2. Understanding the output files

===== Parameters file

The parameters file (`<query_name>_parameters.txt`) contains information about the query execution, including:

* The query model used
* The options provided (e.g., class, from, to)
* The timestamp of the query execution

Example content:

[source]
----
Query Model: MI_AP
Options:
  from: http://purl.obolibrary.org/obo/MPHPO_0000003
  to: http://purl.obolibrary.org/obo/HOSO_0000031
Timestamp: 2025-05-23 13:18:05
----

===== Catalog result file

The catalog result file (`<query_name>_catalog_result.txt`) contains the results of the catalog query, which is used to verify and retrieve table IDs from the OntoRelCat catalog. This file includes:

* The SQL query executed against the OntoRelCat catalog
* The results of the query, including table IDs and their corresponding ontological entities
* A verification report showing which tables were found in the catalog

Example content:

[source]
----
TABLE VERIFICATION REPORT
========================

Table ID: T5b22144800
  - Found as CLASS: MPHPO HOSD beginning temporal information (IRI: http://purl.obolibrary.org/obo/MPHPO_0000003)

Table ID: Tbe02328700
  - Found as CLASS AXIOM: Domain: MPHPO HOSD beginning temporal information, Property: component of, Range: healthcare organization service delivery beginning statement (IRI: http://purl.obolibrary.org/obo/OpenLHS-Core_0000070)

...
----

===== Query SQL file

The query SQL file (`<query_name>_query.sql`) contains the SQL query that was executed against the database. This file is useful for:

* Understanding how OntoRelQuery translates ontological relationships into SQL
* Debugging query issues
* Reusing the query in other SQL tools

===== Result CSV File

The result CSV file (`<query_name>_result.csv`) contains the query results in CSV format. This file can be imported into spreadsheet applications or other data analysis tools. The file includes:

* Column headers corresponding to the selected attributes
* Data rows containing the query results

Example content:

[source,csv]
----
"uid MPHPO HOSD beginning temporal information","uid healthcare organization service delivery beginning statement","uid healthcare organization service delivery identifier","uid healthcare organization service delivery","uid healthcare organization clinical visit","uid hospitalization","has temporal value"
...
----

===== Graph DOT files

The graph DOT files (`<query_name>_ontorel_subgraph.dot` and `<query_name>_onto_subgraph.dot`) contain representations of the subgraphs used for the query. These files can be visualized using tools like Graphviz to understand the relationships between the entities involved in the query.

Example content of `<query_name>_onto_subgraph.dot`:

[source]
----
digraph G {
  "MPHPO_0000003" [label="MPHPO HOSD beginning temporal information"];
  "HOSO_0000055" [label="healthcare organization service delivery beginning statement"];
  "HOSO_0000100" [label="healthcare organization service delivery identifier"];
  "HOSO_0000011" [label="healthcare organization service delivery"];
  "HOSO_0000012" [label="healthcare organization clinical visit"];
  "HOSO_0000031" [label="hospitalization"];
  
  "MPHPO_0000003" -> "HOSO_0000055" [label="component of"];
  "HOSO_0000055" -> "HOSO_0000100" [label="has component"];
  "HOSO_0000100" -> "HOSO_0000011" [label="denotes"];
  "HOSO_0000011" -> "HOSO_0000012" [label="ISA"];
  "HOSO_0000012" -> "HOSO_0000031" [label="ISA"];
}
----

===== Paths file

The paths file (`<query_name>_paths.txt`) contains information about the paths selected for the query, particularly useful for path-based queries (MI_). This file includes:

* The available paths in the ontological graph
* The available paths in the OntoRel graph
* The selected path

Example content:

[source]
----
Available paths in OntoGraph:
  1. (MPHPO HOSD beginning temporal information (MPHPO_0000003)) -[component of [OBJECT_PROPERTY]]-> (healthcare organization service delivery beginning statement (HOSO_0000055)) -[has component [OBJECT_PROPERTY]]-> (healthcare organization service delivery identifier (HOSO_0000100)) -[denotes [OBJECT_PROPERTY]]-> (healthcare organization service delivery (HOSO_0000011)) -[ISA]-> (healthcare organization clinical visit (HOSO_0000012)) -[ISA]-> (hospitalization (HOSO_0000031))

Available paths in OntoRelGraph:
  1. MPHPO HOSD beginning temporal information (T5b22144800) -> (MPHPO HOSD beginning temporal information component of healthcare organization service delivery beginning statement [Tbe02328700]) -> healthcare organization service delivery beginning statement (Tfa4502a400) -> (healthcare organization service delivery beginning statement has component healthcare organization service delivery identifier [T5b5e0b4000]) -> healthcare organization service delivery identifier (Tfa4505c500) -> (healthcare organization service delivery identifier denotes healthcare organization service delivery [T528b9c8100]) -> healthcare organization service delivery (Tfa45022400) -> healthcare organization clinical visit (Tfa45022500) -> hospitalization (Tfa45026200)

Selected path: 1
----

==== Using the output artifacts

The output artifacts can be used for various purposes:

* *Analysis*: The CSV result file can be imported into data analysis tools for further processing.
* *Visualization*: The DOT files can be visualized using tools like Graphviz to understand the relationships between entities.
* *Documentation*: The parameters and paths files provide documentation of the query execution for future reference.
* *Debugging*: The SQL query file can be used to debug issues with the query execution.
* *Reuse*: The SQL query can be reused in other SQL tools or applications.

==== Visualizing DOT files

To visualize the DOT files, you can use tools like Graphviz:

[source,bash]
----
# Install Graphviz
# For Windows: Download from https://graphviz.org/download/
# For macOS: brew install graphviz
# For Linux: sudo apt install graphviz

# Generate a PNG image from a DOT file
dot -Tpng -o path_visualization.png Patient_onto_subgraph.dot

# Generate an SVG image from a DOT file
dot -Tsvg -o path_visualization.svg Patient_onto_subgraph.dot
----

The generated images will show the relationships between the entities involved in the query, making it easier to understand the ontological structure.

=== Example queries

Here are some example queries you can run with OntoRelQuery.

.Exemple 1 .Finding all possible paths between two classes
[source]
----
> !MI_AP
╔══════════════════════════════════════════════════════════════════════════════╗
║                               QUERY EXECUTION                                ║
╚══════════════════════════════════════════════════════════════════════════════╝
Selected model: MI_AP - Querying all possible paths between two classes

Collecting query parameters:
Enter value for from: http://purl.obolibrary.org/obo/MPHPO_0000003
Enter value for to: http://purl.obolibrary.org/obo/HOSO_0000031

Loading ontology graph...
OntoGraph loaded successfully from: Graphs/OntoGraph.dot

Loading ontology-relational graph...
OntoRelGraph loaded successfully from: Graphs/OntoRelGraph.dot

╔══════════════════════════════════════════════════════════════════════════════╗
║                                PATH SELECTION                                ║
╚══════════════════════════════════════════════════════════════════════════════╝

Finding and selecting paths...
Finding paths between http://purl.obolibrary.org/obo/MPHPO_0000003 and http://purl.obolibrary.org/obo/HOSO_0000031...
╔══════════════════════════════════════════════════════════════════════════════╗
║                                PATH SELECTION                                ║
╚══════════════════════════════════════════════════════════════════════════════╝
Please select a path to use for your query. The paths represent different
ways to navigate between the selected concepts.

Available paths in OntoGraph:
  1. (MPHPO HOSD beginning temporal information (MPHPO_0000003)) -[component of [OBJECT_PROPERTY]]-> (healthcare organization service delivery beginning statement (HOSO_0000055)) -[has component [OBJECT_PROPERTY]]-> (healthcare organization service delivery identifier (HOSO_0000100)) -[denotes [OBJECT_PROPERTY]]-> (healthcare organization service delivery (HOSO_0000011)) -[ISA]-> (healthcare organization clinical visit (HOSO_0000012)) -[ISA]-> (hospitalization (HOSO_0000031))

Available paths in OntoRelGraph:
  1. MPHPO HOSD beginning temporal information (T5b22144800) -> (MPHPO HOSD beginning temporal information component of healthcare organization service delivery beginning statement [Tbe02328700]) -> healthcare organization service delivery beginning statement (Tfa4502a400) -> (healthcare organization service delivery beginning statement has component healthcare organization service delivery identifier [T5b5e0b4000]) -> healthcare organization service delivery identifier (Tfa4505c500) -> (healthcare organization service delivery identifier denotes healthcare organization service delivery [T528b9c8100]) -> healthcare organization service delivery (Tfa45022400) -> healthcare organization clinical visit (Tfa45022500) -> hospitalization (Tfa45026200)

Select a path number (1-1): 1
----

== Troubleshooting

This section provides solutions to common issues you might encounter when setting up and using OntoRelQuery.

=== Database connection issues

==== Connection refused

If you see an error like "Connection refused", check that:

* PostgreSQL is running
* The host and port in the configuration file are correct
* The database exists
* The username and password are correct

==== Schema not found

If you see an error like "Schema not found", check that:

* The schema names in the configuration file are correct
* The SQL scripts were executed successfully

=== Graph loading issues

If you see an error like "Failed to load graph", check that:

* The graph files exist at the specified paths
* The graph files are valid DOT files
* The graph files have the correct permissions

=== Query execution issues

If you encounter issues when executing queries, check that:

* The database contains the necessary data
* The class or property names are correct
* The query model is appropriate for your use case

== Q&A

=== What is OntoRelQuery?

OntoRelQuery is a tool for generating and executing queries based on ontological relationships.
It bridges the gap between ontological models and relational databases, allowing users to create complex
queries without detailed knowledge of the underlying database schema.

=== What are the system requirements?

* Java 11 or higher
* PostgreSQL 12 or higher
* At least 4GB of RAM
* At least 1GB of free disk space

=== Can i use a different database?

Currently, OntoRelQuery is optimized for PostgreSQL. Support for other databases may be added in future versions.

== Conclusion

Congratulations! You have successfully set up OntoRelQuery and learned how to use it to query relational data using ontology-based models.

With OntoRelQuery, you can:

* Generate queries from ontological class relationships
* Execute various query patterns through different query models
* Create path-based queries between ontological concepts
* Export and format query results

== Contact and Support

For questions, bug reports, or feature requests, please contact:

* Mohamed Amin Gaied (Mohamed.Amin.Gaied@USherbrooke.ca)
* Christina Khnaisser (Christina.Khnaisser@USherbrooke.ca)

Developed by https://griis.ca/[GRIIS] - Groupe de recherche interdisciplinaire en informatique de la santé, Université de Sherbrooke (Québec) J1K 2R1, CANADA.

Thank you for using OntoRelQuery!
